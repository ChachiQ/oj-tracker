{% extends "base.html" %}
{% from "_macros.html" import page_header, empty_state %}

{% block title %}同步日志 - OJ Tracker{% endblock %}

{% block content %}
{% call page_header('同步日志', 'bi-clock-history') %}
    <a href="{{ url_for('settings.index') }}" class="btn btn-sm btn-outline-secondary">
        <i class="bi bi-gear"></i> 返回设置
    </a>
{% endcall %}

{% if jobs and jobs|length > 0 %}
<div class="card shadow-sm">
    <div class="card-body p-0">
        <div class="table-responsive">
            <table class="table table-hover mb-0 align-middle">
                <thead class="table-light">
                    <tr>
                        <th>时间</th>
                        <th>类型</th>
                        <th>平台/账号</th>
                        <th>状态</th>
                        <th>进度</th>
                        <th>统计</th>
                        <th class="text-end">耗时</th>
                    </tr>
                </thead>
                <tbody>
                    {% for job in jobs %}
                    <tr data-job-id="{{ job.id }}" data-status="{{ job.status }}"
                        style="cursor:pointer" onclick="toggleJobDetail({{ job.id }}, this)">
                        <td>
                            <small title="{{ job.created_at|datefmt }}" data-bs-toggle="tooltip">
                                {{ job.created_at|smarttime }}
                            </small>
                        </td>
                        <td>
                            {% if job.job_type == 'content_sync' %}
                                <span class="badge bg-primary">内容同步</span>
                            {% elif job.job_type == 'ai_backfill' %}
                                <span class="badge bg-info text-dark">AI 回填</span>
                            {% else %}
                                <span class="badge bg-secondary">{{ job.job_type }}</span>
                            {% endif %}
                        </td>
                        <td>
                            {% if job.platform_account %}
                                <small>{{ job.platform_account.platform }}:{{ job.platform_account.platform_uid }}</small>
                            {% else %}
                                <small class="text-muted">全部</small>
                            {% endif %}
                        </td>
                        <td>
                            {% if job.status == 'completed' %}
                                <span class="badge bg-success"><i class="bi bi-check-circle"></i> 完成</span>
                            {% elif job.status == 'running' %}
                                <span class="badge bg-warning text-dark">
                                    <span class="spinner-border spinner-border-sm" style="width:.7rem;height:.7rem"></span>
                                    运行中
                                </span>
                                <button class="btn btn-sm btn-outline-danger ms-1 btn-cancel-job"
                                        data-job-id="{{ job.id }}" onclick="event.stopPropagation()">
                                    <i class="bi bi-x-lg"></i>
                                </button>
                            {% elif job.status == 'failed' %}
                                <span class="badge bg-danger" title="{{ job.error_message or '' }}" data-bs-toggle="tooltip">
                                    <i class="bi bi-x-circle"></i> 失败
                                </span>
                            {% elif job.status == 'pending' %}
                                <span class="badge bg-secondary">等待中</span>
                                <button class="btn btn-sm btn-outline-danger ms-1 btn-cancel-job"
                                        data-job-id="{{ job.id }}" onclick="event.stopPropagation()">
                                    <i class="bi bi-x-lg"></i>
                                </button>
                            {% endif %}
                        </td>
                        <td>
                            {% if job.job_type == 'ai_backfill' and job.current_phase %}
                                {% set phase_labels = {'comprehensive': '综合分析', 'review': '审查', 'classify': '分类', 'solution': '思路', 'full_solution': '解题'} %}
                                <small>{{ phase_labels.get(job.current_phase, job.current_phase) }}
                                {% if job.progress_total > 0 %}
                                    {{ job.progress_current }}/{{ job.progress_total }}
                                {% endif %}
                                </small>
                            {% elif job.status == 'running' %}
                                <small class="text-muted">...</small>
                            {% else %}
                                <small class="text-muted">-</small>
                            {% endif %}
                        </td>
                        <td>
                            {% set stats = job.stats %}
                            {% if job.job_type == 'content_sync' and stats %}
                                <small>
                                    {% if stats.get('accounts_synced') is not none %}
                                        {{ stats.accounts_synced }} 账号,
                                        提交+{{ stats.get('total_new_submissions', 0) }}
                                        题目+{{ stats.get('total_new_problems', 0) }}
                                    {% else %}
                                        提交+{{ stats.get('new_submissions', 0) }}
                                        题目+{{ stats.get('new_problems', 0) }}
                                    {% endif %}
                                </small>
                            {% elif job.job_type == 'ai_backfill' and stats %}
                                <small>
                                    {% if stats.get('comprehensive_total') is not none %}
                                    综合 {{ stats.get('comprehensive_ok', 0) }}/{{ stats.get('comprehensive_total', 0) }}
                                    | 审查 {{ stats.get('review_ok', 0) }}/{{ stats.get('review_total', 0) }}
                                    {% else %}
                                    分类 {{ stats.get('classify_ok', 0) }}/{{ stats.get('classify_total', 0) }}
                                    | 思路 {{ stats.get('solution_ok', 0) }}/{{ stats.get('solution_total', 0) }}
                                    | 解题 {{ stats.get('full_solution_ok', 0) }}/{{ stats.get('full_solution_total', 0) }}
                                    | 审查 {{ stats.get('review_ok', 0) }}/{{ stats.get('review_total', 0) }}
                                    {% endif %}
                                </small>
                            {% else %}
                                <small class="text-muted">-</small>
                            {% endif %}
                        </td>
                        <td class="text-end">
                            {% if job.duration_seconds is not none %}
                                {% if job.duration_seconds >= 60 %}
                                    <small>{{ (job.duration_seconds // 60) }}m {{ (job.duration_seconds % 60) }}s</small>
                                {% else %}
                                    <small>{{ job.duration_seconds }}s</small>
                                {% endif %}
                            {% else %}
                                <small class="text-muted">-</small>
                            {% endif %}
                        </td>
                    </tr>
                    {# Detail expansion row (hidden by default) #}
                    <tr id="detail-row-{{ job.id }}" class="d-none" onclick="event.stopPropagation()">
                        <td colspan="7" class="bg-light p-3" id="detail-content-{{ job.id }}">
                            <div class="text-center text-muted"><span class="spinner-border spinner-border-sm"></span> 加载中...</div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>
{% else %}
{{ empty_state('bi-clock-history', '暂无同步记录', '同步数据后会在这里显示历史记录。',
               action_url=url_for('settings.index'), action_text='前往设置', action_icon='bi-gear') }}
{% endif %}
{% endblock %}

{% block extra_scripts %}
<script>
(function() {
    // Auto-refresh if there's a running or pending job
    var hasRunning = document.querySelector('tr[data-status="running"], tr[data-status="pending"]');
    if (hasRunning) {
        setTimeout(function() { location.reload(); }, 5000);
    }

    // Tooltips
    document.querySelectorAll('[data-bs-toggle="tooltip"]').forEach(function(el) {
        new bootstrap.Tooltip(el);
    });

    // Cancel job buttons
    var csrfToken = document.querySelector('meta[name="csrf-token"]')?.getAttribute('content') || '';
    document.querySelectorAll('.btn-cancel-job').forEach(function(btn) {
        btn.addEventListener('click', function() {
            var jobId = this.dataset.jobId;
            fetch('/sync/job/' + jobId + '/cancel', {
                method: 'POST',
                headers: {'X-CSRFToken': csrfToken}
            })
            .then(function(r) { return r.json(); })
            .then(function(data) {
                if (data.success) location.reload();
                else alert(data.message);
            });
        });
    });

    // ── Job detail expansion ──
    var detailCache = {};

    window.toggleJobDetail = function(jobId, triggerRow) {
        var detailRow = document.getElementById('detail-row-' + jobId);
        if (!detailRow) return;

        // Toggle visibility
        if (!detailRow.classList.contains('d-none')) {
            detailRow.classList.add('d-none');
            return;
        }

        detailRow.classList.remove('d-none');

        // Use cache if available
        if (detailCache[jobId]) {
            renderJobDetail(jobId, detailCache[jobId]);
            return;
        }

        // Fetch detail
        fetch('/sync/job/' + jobId + '/detail', {
            headers: {'X-CSRFToken': csrfToken}
        })
        .then(function(r) { return r.json(); })
        .then(function(data) {
            detailCache[jobId] = data;
            renderJobDetail(jobId, data);
        })
        .catch(function() {
            document.getElementById('detail-content-' + jobId).innerHTML =
                '<div class="text-danger"><i class="bi bi-exclamation-triangle"></i> 加载失败</div>';
        });
    };

    function renderJobDetail(jobId, data) {
        var container = document.getElementById('detail-content-' + jobId);
        var html = '';

        if (data.error_message) {
            html += '<div class="alert alert-danger py-1 mb-2 small"><i class="bi bi-exclamation-triangle"></i> ' +
                    escapeHtml(data.error_message) + '</div>';
        }

        if (data.job_type === 'content_sync') {
            html += renderContentSyncDetail(data);
        } else if (data.job_type === 'ai_backfill') {
            html += renderAIBackfillDetail(data);
        }

        if (!html) {
            html = '<div class="text-muted small">无详细信息</div>';
        }

        container.innerHTML = html;
    }

    function renderContentSyncDetail(data) {
        var details = data.account_details || [];
        if (details.length === 0) return '<div class="text-muted small">无账号同步记录</div>';

        var html = '<table class="table table-sm table-bordered mb-0 small">';
        html += '<thead class="table-light"><tr><th>平台</th><th>账号</th><th>学生</th><th>新提交</th><th>新题目</th><th>状态</th></tr></thead><tbody>';

        for (var i = 0; i < details.length; i++) {
            var d = details[i];
            html += '<tr>';
            html += '<td>' + escapeHtml(d.platform || '') + '</td>';
            html += '<td><code>' + escapeHtml(d.platform_uid || '') + '</code></td>';
            html += '<td>' + escapeHtml(d.student_name || '') + '</td>';
            if (d.status === 'ok') {
                html += '<td>' + (d.new_submissions || 0) + '</td>';
                html += '<td>' + (d.new_problems || 0) + '</td>';
                html += '<td><span class="badge bg-success">成功</span></td>';
            } else {
                html += '<td colspan="2" class="text-danger">' + escapeHtml(d.error || '未知错误') + '</td>';
                html += '<td><span class="badge bg-danger">失败</span></td>';
            }
            html += '</tr>';
        }

        html += '</tbody></table>';

        if (data.errors && data.errors.length > 0) {
            html += '<div class="mt-2 small text-danger">';
            for (var j = 0; j < data.errors.length; j++) {
                html += '<div><i class="bi bi-exclamation-circle"></i> ' + escapeHtml(data.errors[j]) + '</div>';
            }
            html += '</div>';
        }

        return html;
    }

    function renderAIBackfillDetail(data) {
        var html = '';
        var comp = data.comprehensive || [];
        var revs = data.reviews || [];

        if (comp.length > 0) {
            html += '<div class="fw-bold small mb-1">综合分析 (' + comp.length + ')</div>';
            html += '<table class="table table-sm table-bordered mb-2 small">';
            html += '<thead class="table-light"><tr><th>题目</th><th>平台</th><th>题号</th><th>类型</th><th>模型</th><th class="text-end">费用</th></tr></thead><tbody>';

            var typeLabels = {
                'problem_classify': '分类',
                'problem_solution': '思路',
                'problem_full_solution': '解题',
            };
            for (var i = 0; i < comp.length; i++) {
                var c = comp[i];
                html += '<tr>';
                html += '<td>' + escapeHtml(c.problem_name || '-') + '</td>';
                html += '<td>' + escapeHtml(c.platform || '-') + '</td>';
                html += '<td><code>' + escapeHtml(c.problem_id || '-') + '</code></td>';
                html += '<td>' + (typeLabels[c.analysis_type] || c.analysis_type) + '</td>';
                html += '<td><code class="small">' + escapeHtml(c.model || '-') + '</code></td>';
                html += '<td class="text-end">$' + (c.cost || 0).toFixed(6) + '</td>';
                html += '</tr>';
            }
            html += '</tbody></table>';
        }

        if (revs.length > 0) {
            html += '<div class="fw-bold small mb-1">代码审查 (' + revs.length + ')</div>';
            html += '<table class="table table-sm table-bordered mb-2 small">';
            html += '<thead class="table-light"><tr><th>题目</th><th>提交状态</th><th>模型</th><th class="text-end">费用</th></tr></thead><tbody>';

            for (var j = 0; j < revs.length; j++) {
                var r = revs[j];
                html += '<tr>';
                html += '<td>' + escapeHtml(r.problem_name || '-') + '</td>';
                html += '<td>' + escapeHtml(r.submission_status || '-') + '</td>';
                html += '<td><code class="small">' + escapeHtml(r.model || '-') + '</code></td>';
                html += '<td class="text-end">$' + (r.cost || 0).toFixed(6) + '</td>';
                html += '</tr>';
            }
            html += '</tbody></table>';
        }

        if (comp.length === 0 && revs.length === 0) {
            html += '<div class="text-muted small">无分析记录</div>';
        }

        if (data.total_cost > 0) {
            html += '<div class="text-end small fw-bold">总费用: $' + data.total_cost.toFixed(6) + '</div>';
        }

        return html;
    }

    function escapeHtml(str) {
        var div = document.createElement('div');
        div.textContent = str;
        return div.innerHTML;
    }
})();
</script>
{% endblock %}
