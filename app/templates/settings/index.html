{% extends "base.html" %}
{% from "_macros.html" import empty_state, table_col_class %}

{% block title %}设置 - OJ Tracker{% endblock %}

{% block content %}
<h4 class="fw-bold mb-4"><i class="bi bi-gear"></i> 系统设置</h4>

{# ── Section 1: Platform Accounts (full width) ── #}
<div class="card shadow-sm mb-4">
    <div class="card-header d-flex justify-content-between align-items-center flex-wrap gap-2">
        <h5 class="mb-0"><i class="bi bi-hdd-network"></i> 平台账号管理</h5>
        <div class="d-flex gap-2">
            <button type="button" class="btn btn-sm btn-outline-primary" data-bs-toggle="modal" data-bs-target="#addAccountModal">
                <i class="bi bi-plus-circle"></i> 添加账号
            </button>
            <form method="POST" action="{{ url_for('settings.sync_all') }}" class="d-inline">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <button type="submit" class="btn btn-sm btn-outline-success">
                    <i class="bi bi-arrow-repeat"></i> 全部同步
                </button>
            </form>
        </div>
    </div>
    <div class="card-body">
        {% if accounts and accounts|length > 0 %}
        <div class="table-responsive">
            <table class="table table-hover mb-0">
                <thead class="table-light">
                    <tr>
                        <th>学生</th>
                        <th>平台</th>
                        <th class="{{ table_col_class('md') }}">账号 ID</th>
                        <th>状态</th>
                        <th class="{{ table_col_class('md') }}">最后同步</th>
                        <th class="text-center">操作</th>
                    </tr>
                </thead>
                <tbody>
                    {% for account in accounts %}
                    <tr>
                        <td>{{ account.student.name if account.student else '-' }}</td>
                        <td>
                            {% set platform_icons = {
                                'luogu': 'bi-trophy',
                                'bbcoj': 'bi-pc-display',
                                'ybt': 'bi-book',
                                'codeforces': 'bi-globe',
                                'atcoder': 'bi-flag',
                                'leetcode': 'bi-code-square',
                                'nowcoder': 'bi-braces',
                                'hdu': 'bi-cpu',
                                'poj': 'bi-server',
                                'bzoj': 'bi-hdd',
                                'uoj': 'bi-motherboard',
                                'loj': 'bi-pc-display'
                            } %}
                            <i class="bi {{ platform_icons.get(account.platform, 'bi-globe') }}"></i>
                            {{ account.platform }}
                        </td>
                        <td class="{{ table_col_class('md') }}"><code>{{ account.platform_uid }}</code></td>
                        <td>
                            {% if account.last_sync_error %}
                                <span class="badge bg-warning text-dark" title="{{ account.last_sync_error }}" data-bs-toggle="tooltip">
                                    <i class="bi bi-exclamation-triangle"></i> 同步异常
                                </span>
                            {% elif account.is_active %}
                                <span class="badge bg-success"><i class="bi bi-check-circle"></i> 正常</span>
                            {% else %}
                                <span class="badge bg-danger"><i class="bi bi-x-circle"></i> 已停用</span>
                            {% endif %}
                        </td>
                        <td class="{{ table_col_class('md') }}">
                            {% if account.last_sync_at %}
                                <small>{{ account.last_sync_at.strftime('%Y-%m-%d %H:%M') }}</small>
                            {% else %}
                                <span class="text-muted">未同步</span>
                            {% endif %}
                        </td>
                        <td class="text-center">
                            <div class="btn-group btn-group-sm">
                                <form method="POST" action="{{ url_for('settings.sync_account', account_id=account.id) }}" class="d-inline"
                                      {% if account.platform in requires_login_platforms %}
                                      onsubmit="return confirm('该平台需要登录同步，会踢掉你在{{ account.platform }}网站上的活跃会话，确定继续？')"
                                      {% endif %}>
                                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                    <button type="submit" class="btn btn-outline-success" title="同步数据">
                                        <i class="bi bi-arrow-repeat"></i>
                                    </button>
                                </form>
                                <form method="POST" action="{{ url_for('settings.delete_account', account_id=account.id) }}"
                                      class="d-inline" onsubmit="return confirm('确定要删除该账号吗？关联的提交记录不会被删除。')">
                                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                    <button type="submit" class="btn btn-outline-danger" title="删除账号">
                                        <i class="bi bi-trash"></i>
                                    </button>
                                </form>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        {{ empty_state('bi-link-45deg', '', '暂无平台账号，点击"添加账号"按钮开始绑定。', small=true) }}
        {% endif %}
    </div>
</div>

{# ── Section 2 & 3: AI Config (left) + Pricing & Platform Instructions (right) ── #}
<div class="row g-4">
    {# Left column: AI Configuration #}
    <div class="col-12 col-lg-7">
        <div class="card shadow-sm h-100">
            <div class="card-header">
                <h5 class="mb-0"><i class="bi bi-robot"></i> AI 分析配置</h5>
            </div>
            <div class="card-body">
                <form method="POST" action="{{ url_for('settings.save_ai_config') }}">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">

                    {# Provider selection #}
                    <div class="mb-3">
                        <label class="form-label fw-bold">AI 提供者</label>
                        <div class="row g-2">
                            {% set providers = [
                                {'id': 'claude', 'name': 'Claude', 'icon': 'bi-cloud', 'color': 'primary'},
                                {'id': 'openai', 'name': 'OpenAI', 'icon': 'bi-stars', 'color': 'success'},
                                {'id': 'zhipu', 'name': '智谱 AI', 'icon': 'bi-translate', 'color': 'info'}
                            ] %}
                            {% for p in providers %}
                            <div class="col-4">
                                <input type="radio" class="btn-check" name="ai_provider" id="provider-{{ p.id }}"
                                       value="{{ p.id }}" {{ 'checked' if user_ai_provider == p.id else '' }} autocomplete="off">
                                <label class="btn btn-outline-{{ p.color }} w-100 py-2" for="provider-{{ p.id }}">
                                    <i class="bi {{ p.icon }} d-block mb-1"></i>
                                    <small>{{ p.name }}</small>
                                </label>
                            </div>
                            {% endfor %}
                        </div>
                        {% if model_config %}
                        <div class="form-text mt-2">
                            {% for pname, pconf in model_config.items() %}
                            <span class="d-block" id="model-info-{{ pname }}" style="{{ '' if user_ai_provider == pname else 'display:none' }}">
                                {% for mname, minfo in pconf.get('models', {}).items() %}
                                <small class="text-muted">{{ mname }} ({{ minfo.get('tier','') }})</small>{{ '、' if not loop.last else '' }}
                                {% endfor %}
                            </span>
                            {% endfor %}
                        </div>
                        {% endif %}
                    </div>

                    {# API Keys #}
                    <div class="mb-3">
                        <label class="form-label fw-bold">API KEY</label>
                        {% for p in ['claude', 'openai', 'zhipu'] %}
                        <div class="input-group input-group-sm mb-2" id="key-group-{{ p }}">
                            <span class="input-group-text" style="min-width:70px">{{ p }}</span>
                            <input type="password" class="form-control" name="api_key_{{ p }}"
                                   placeholder="{{ '已配置' if user_has_key.get(p) else '未配置，留空使用环境变量' }}"
                                   autocomplete="new-password">
                            {% if user_has_key.get(p) %}
                            <span class="input-group-text text-success"><i class="bi bi-check-circle-fill"></i></span>
                            {% endif %}
                        </div>
                        {% endfor %}
                        <div class="form-text">留空不会覆盖已有 KEY。优先使用此处配置，未配置时回退到环境变量。</div>
                    </div>

                    {# Monthly budget #}
                    <div class="mb-3">
                        <label for="ai-budget" class="form-label fw-bold">月度预算 (USD)</label>
                        <input type="number" class="form-control form-control-sm" id="ai-budget"
                               name="ai_monthly_budget" step="0.5" min="0"
                               placeholder="{{ user_monthly_budget or monthly_budget }}"
                               value="{{ user_monthly_budget or '' }}">
                    </div>

                    <button type="submit" class="btn btn-primary btn-sm">
                        <i class="bi bi-save"></i> 保存 AI 配置
                    </button>
                </form>
            </div>
        </div>
    </div>

    {# Right column: Model Pricing + Platform Instructions stacked #}
    <div class="col-12 col-lg-5">
        {# Model Pricing & Usage #}
        <div class="card shadow-sm mb-4">
            <div class="card-header">
                <h5 class="mb-0"><i class="bi bi-currency-dollar"></i> 费用与用量</h5>
            </div>
            <div class="card-body pb-2">
                {# Monthly budget progress #}
                <div class="d-flex justify-content-between align-items-center mb-1">
                    <small class="text-muted">本月预算</small>
                    <span class="fw-bold small">
                        ${{ '%.4f'|format(monthly_cost or 0) }} / ${{ '%.2f'|format(monthly_budget or 5) }}
                    </span>
                </div>
                {% set cost_pct = ((monthly_cost or 0) / (monthly_budget or 5) * 100)|int %}
                <div class="progress mb-2" style="height: 6px;">
                    <div class="progress-bar {{ 'bg-danger' if cost_pct > 80 else 'bg-warning' if cost_pct > 50 else 'bg-success' }}"
                         style="width: {{ [cost_pct, 100]|min }}%"></div>
                </div>
                <div class="d-flex justify-content-between mb-3">
                    <small class="text-muted">已分析 <span class="fw-bold text-body">{{ analyzed_count or 0 }}</span> 题</small>
                </div>
            </div>

            {# Build usage lookup dict from usage_by_model tuples #}
            {% set ns = namespace(usage_map={}) %}
            {% if usage_by_model %}
            {% for model_name, call_count, tokens, cost in usage_by_model %}
                {% set _ = ns.usage_map.update({model_name: {'calls': call_count, 'tokens': tokens or 0, 'cost': cost or 0}}) %}
            {% endfor %}
            {% endif %}

            {% set provider_display = {'claude': 'Claude', 'openai': 'OpenAI', 'zhipu': '智谱 AI'} %}
            {% set provider_colors  = {'claude': 'primary', 'openai': 'success', 'zhipu': 'info'} %}
            {% set tier_labels      = {'basic': '基础', 'advanced': '高级'} %}

            <div class="table-responsive">
                <table class="table table-sm mb-0 align-middle">
                    <thead class="table-light">
                        <tr>
                            <th colspan="3" class="border-end">模型与定价 <small class="fw-normal text-muted">($/M tokens)</small></th>
                            <th colspan="3" class="text-center">本月用量</th>
                        </tr>
                        <tr class="text-muted small">
                            <th>提供者</th>
                            <th>模型</th>
                            <th class="text-end border-end">输入 / 输出</th>
                            <th class="text-end">调用</th>
                            <th class="text-end">Token</th>
                            <th class="text-end">费用</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for pname, pconf in model_config.items() %}
                        {% set models = pconf.get('models', {}) %}
                        {% for mname, minfo in models.items() %}
                        {% set usage = ns.usage_map.get(mname, {}) %}
                        <tr>
                            {% if loop.first %}
                            <td rowspan="{{ models|length }}" class="align-middle">
                                <span class="badge bg-{{ provider_colors.get(pname, 'secondary') }}">{{ provider_display.get(pname, pname) }}</span>
                            </td>
                            {% endif %}
                            <td>
                                <code class="small">{{ mname }}</code>
                                <span class="badge bg-{{ 'secondary' if minfo.get('tier') == 'basic' else 'dark' }} bg-opacity-75 ms-1" style="font-size:.6rem">
                                    {{ tier_labels.get(minfo.get('tier', ''), '') }}
                                </span>
                            </td>
                            <td class="text-end border-end text-nowrap">
                                {% if minfo.get('input_price', 0) == 0 and minfo.get('output_price', 0) == 0 %}
                                <span class="text-success fw-bold small">免费</span>
                                {% else %}
                                <small>${{ '%.2f'|format(minfo.get('input_price', 0)) }} / ${{ '%.2f'|format(minfo.get('output_price', 0)) }}</small>
                                {% endif %}
                            </td>
                            <td class="text-end">
                                {% if usage %}
                                <small>{{ usage.calls }}</small>
                                {% else %}
                                <small class="text-muted">-</small>
                                {% endif %}
                            </td>
                            <td class="text-end">
                                {% if usage %}
                                <small>{{ '{:,}'.format(usage.tokens) }}</small>
                                {% else %}
                                <small class="text-muted">-</small>
                                {% endif %}
                            </td>
                            <td class="text-end">
                                {% if usage %}
                                <small class="fw-bold">${{ '%.4f'|format(usage.cost) }}</small>
                                {% else %}
                                <small class="text-muted">-</small>
                                {% endif %}
                            </td>
                        </tr>
                        {% endfor %}
                        {% endfor %}
                    </tbody>
                    {% if monthly_cost and monthly_cost > 0 %}
                    <tfoot class="table-light">
                        <tr class="fw-bold">
                            <td colspan="3" class="text-end border-end"><small>合计</small></td>
                            <td class="text-end"><small>{{ analyzed_count or 0 }}</small></td>
                            <td></td>
                            <td class="text-end"><small>${{ '%.4f'|format(monthly_cost or 0) }}</small></td>
                        </tr>
                    </tfoot>
                    {% endif %}
                </table>
            </div>
        </div>

        {# Platform Instructions #}
        <div class="card shadow-sm">
            <div class="card-header">
                <h5 class="mb-0"><i class="bi bi-question-circle"></i> 平台绑定说明</h5>
            </div>
            <div class="card-body p-0">
                <div class="accordion accordion-flush" id="platformInstructions">
                    {% for p in platform_info %}
                    <div class="accordion-item">
                        <h2 class="accordion-header">
                            <button class="accordion-button collapsed" type="button"
                                    data-bs-toggle="collapse" data-bs-target="#instr-{{ p.name }}"
                                    aria-expanded="false" aria-controls="instr-{{ p.name }}">
                                {{ p.display }}
                                {% if p.requires_login %}
                                <span class="badge bg-warning text-dark ms-2">需登录</span>
                                {% endif %}
                            </button>
                        </h2>
                        <div id="instr-{{ p.name }}" class="accordion-collapse collapse"
                             data-bs-parent="#platformInstructions">
                            <div class="accordion-body">
                                {{ p.instructions }}
                                {% if p.requires_login %}
                                <div class="alert alert-warning mt-2 mb-0 py-2 small">
                                    <i class="bi bi-exclamation-triangle"></i>
                                    此平台需要密码登录同步数据，登录后会踢掉你在该OJ网站上的活跃会话。建议在不使用该OJ时进行同步。
                                </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
</div>

{# ── Add Account Modal ── #}
<div class="modal fade" id="addAccountModal" tabindex="-1" aria-labelledby="addAccountModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <form method="POST" action="{{ url_for('settings.add_account') }}">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <div class="modal-header">
                    <h5 class="modal-title" id="addAccountModalLabel">
                        <i class="bi bi-plus-circle"></i> 添加平台账号
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="关闭"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="add-student" class="form-label">选择学生 <span class="text-danger">*</span></label>
                        <select class="form-select" id="add-student" name="student_id" required>
                            <option value="">-- 请选择学生 --</option>
                            {% for s in students %}
                            <option value="{{ s.id }}">{{ s.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="add-platform" class="form-label">平台 <span class="text-danger">*</span></label>
                        <select class="form-select" id="add-platform" name="platform" required>
                            <option value="">-- 请选择平台 --</option>
                            {% for p in platform_info %}
                            <option value="{{ p.name }}" data-requires-login="{{ 'true' if p.requires_login else 'false' }}">
                                {{ p.display }}{% if p.requires_login %} (需登录){% endif %}
                            </option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="add-uid" class="form-label">平台用户 ID <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" id="add-uid" name="platform_uid"
                               placeholder="如：123456 或 tourist" required>
                    </div>
                    <div class="mb-3" id="password-field" style="display:none">
                        <label for="add-password" class="form-label">密码 <span class="text-danger">*</span></label>
                        <input type="password" class="form-control" id="add-password" name="auth_password"
                               placeholder="输入该平台的登录密码" autocomplete="new-password">
                        <div class="alert alert-warning mt-2 mb-0 py-2 small" id="login-warning">
                            <i class="bi bi-exclamation-triangle"></i>
                            登录同步会踢掉你在该OJ网站上的活跃会话。密码仅用于数据同步。
                        </div>
                    </div>
                    <div class="mb-3" id="cookie-field">
                        <label for="add-cookie" class="form-label">Cookie（可选）</label>
                        <textarea class="form-control" id="add-cookie" name="auth_cookie" rows="3"
                                  placeholder="部分平台需要 Cookie 才能获取完整数据"></textarea>
                        <div class="form-text">仅在需要时填写，Cookie 将加密存储。</div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="submit" class="btn btn-primary">
                        <i class="bi bi-check-circle"></i> 添加
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
(function() {
    // Toggle password / cookie fields based on platform selection
    var platformSelect = document.getElementById('add-platform');
    var passwordField = document.getElementById('password-field');
    var cookieField = document.getElementById('cookie-field');
    var passwordInput = document.getElementById('add-password');

    if (platformSelect) {
        platformSelect.addEventListener('change', function() {
            var selected = this.options[this.selectedIndex];
            var requiresLogin = selected.getAttribute('data-requires-login') === 'true';
            if (requiresLogin) {
                passwordField.style.display = '';
                cookieField.style.display = 'none';
                passwordInput.setAttribute('required', 'required');
            } else {
                passwordField.style.display = 'none';
                cookieField.style.display = '';
                passwordInput.removeAttribute('required');
            }
        });
    }

    // Toggle model info display when provider radio changes
    var providerRadios = document.querySelectorAll('input[name="ai_provider"]');
    providerRadios.forEach(function(radio) {
        radio.addEventListener('change', function() {
            document.querySelectorAll('[id^="model-info-"]').forEach(function(el) {
                el.style.display = 'none';
            });
            var infoEl = document.getElementById('model-info-' + this.value);
            if (infoEl) infoEl.style.display = '';
        });
    });

    // Enable Bootstrap tooltips
    var tooltips = document.querySelectorAll('[data-bs-toggle="tooltip"]');
    tooltips.forEach(function(el) {
        new bootstrap.Tooltip(el);
    });
})();
</script>
{% endblock %}
