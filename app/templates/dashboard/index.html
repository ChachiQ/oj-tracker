{% extends "base.html" %}
{% from "_macros.html" import stat_card, page_header, chart_box, empty_state, student_selector %}

{% block title %}仪表盘 - OJ Tracker{% endblock %}

{% block content %}
<div id="dashboard-container" data-student-id="{{ current_student.id if current_student else '' }}">

    {% call page_header("仪表盘", "bi-speedometer2") %}
        {{ student_selector(students, current_student.id if current_student else none, url_for('dashboard.index')) }}
    {% endcall %}

    {% if not students or students|length == 0 %}
    {{ empty_state('bi-person-plus', '还没有学生', '请先添加一个学生，然后绑定 OJ 平台账号开始追踪。',
                    url_for('student.add_student'), '添加学生', 'bi-plus-circle') }}

    {% elif not current_student %}
    {{ empty_state('bi-arrow-up-circle', '请选择一个学生', '从上方下拉菜单选择要查看的学生。') }}

    {% else %}
    <!-- Stat Cards -->
    <div class="row g-3 mb-4">
        {{ stat_card('总提交题数', '--', 'primary', 'bi-journal-code', '', 'stat-total') }}
        {{ stat_card('通过 (AC)', '--', 'success', 'bi-check-circle', '', 'stat-ac') }}
        {{ stat_card('本周提交', '--', 'warning', 'bi-calendar-week', '', 'stat-week') }}
        {{ stat_card('连续天数', '--', 'primary', 'bi-fire', '#6f42c1', 'stat-streak') }}
    </div>

    <!-- Row 1: Radar + Heatmap -->
    <div class="row g-3 mb-4">
        <div class="col-12 col-lg-5">
            {{ chart_box('radar-chart', '能力雷达图', 'bi-radar') }}
        </div>
        <div class="col-12 col-lg-7">
            {{ chart_box('heatmap-chart', '做题日历', 'bi-calendar3') }}
        </div>
    </div>

    <!-- Row 2: Difficulty Distribution + Recent Submissions -->
    <div class="row g-3 mb-4">
        <div class="col-12 col-lg-5">
            {{ chart_box('difficulty-chart', '难度分布', 'bi-bar-chart') }}
        </div>
        <div class="col-12 col-lg-7">
            <div class="chart-container">
                <div class="chart-title"><i class="bi bi-clock-history"></i> 最近提交</div>
                <div class="table-responsive">
                    <table class="table table-sm table-hover mb-0" id="recent-submissions-table">
                        <thead>
                            <tr>
                                <th>时间</th>
                                <th>平台</th>
                                <th>题目</th>
                                <th>状态</th>
                            </tr>
                        </thead>
                        <tbody id="recent-submissions-body">
                            <tr>
                                <td colspan="4" class="text-center text-muted py-3">
                                    <div class="spinner-border spinner-border-sm" role="status"></div> 加载中...
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Row 3: Weakness Alerts -->
    <div class="chart-container" id="weakness-section" style="display: none;">
        <div class="chart-title"><i class="bi bi-exclamation-triangle text-danger"></i> 薄弱环节提醒</div>
        <div class="row g-3" id="weakness-cards"></div>
    </div>

    <!-- Empty Data State (hidden by default, shown by JS if no data) -->
    <div id="empty-data-state" style="display: none;">
        {{ empty_state('bi-inbox', '暂无做题数据', '请先在设置中绑定 OJ 平台账号并同步数据。',
                        url_for('settings.index'), '前往设置', 'bi-gear', 'btn-outline-primary') }}
    </div>

    {% endif %}
</div>
{% endblock %}

{% block extra_scripts %}
{% if current_student %}
<script src="{{ url_for('static', filename='js/dashboard.js') }}"></script>
{% endif %}
{% endblock %}
