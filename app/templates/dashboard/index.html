{% extends "base.html" %}

{% block title %}仪表盘 - OJ Tracker{% endblock %}

{% block content %}
<div id="dashboard-container" data-student-id="{{ current_student.id if current_student else '' }}">

    <!-- Header with Student Selector -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h4 class="fw-bold mb-0"><i class="bi bi-speedometer2"></i> 仪表盘</h4>
        {% if students and students|length > 0 %}
        <div class="d-flex align-items-center gap-2">
            <label class="form-label mb-0 text-muted">当前学生：</label>
            <select id="student-selector" class="form-select form-select-sm" style="width: auto;"
                    onchange="window.location.href='{{ url_for('dashboard.index') }}?student_id=' + this.value">
                {% for s in students %}
                <option value="{{ s.id }}" {% if current_student and s.id == current_student.id %}selected{% endif %}>
                    {{ s.name }}{% if s.grade %} ({{ s.grade }}){% endif %}
                </option>
                {% endfor %}
            </select>
        </div>
        {% endif %}
    </div>

    {% if not students or students|length == 0 %}
    <!-- No Students State -->
    <div class="text-center py-5">
        <i class="bi bi-person-plus text-muted" style="font-size: 4rem;"></i>
        <h4 class="mt-3 text-muted">还没有学生</h4>
        <p class="text-muted">请先添加一个学生，然后绑定 OJ 平台账号开始追踪。</p>
        <a href="{{ url_for('student.add_student') }}" class="btn btn-primary">
            <i class="bi bi-plus-circle"></i> 添加学生
        </a>
    </div>

    {% elif not current_student %}
    <!-- No Current Student Selected -->
    <div class="text-center py-5">
        <i class="bi bi-arrow-up-circle text-muted" style="font-size: 4rem;"></i>
        <h4 class="mt-3 text-muted">请选择一个学生</h4>
        <p class="text-muted">从上方下拉菜单选择要查看的学生。</p>
    </div>

    {% else %}
    <!-- Stat Cards -->
    <div class="row g-3 mb-4">
        <div class="col-xl-3 col-md-6">
            <div class="card stat-card border-0 h-100" style="border-left-color: var(--primary-color) !important;">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <div class="stat-label">总提交题数</div>
                            <div class="stat-value text-primary" id="stat-total">--</div>
                        </div>
                        <i class="bi bi-journal-code text-primary" style="font-size: 2rem; opacity: 0.3;"></i>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-xl-3 col-md-6">
            <div class="card stat-card border-0 h-100" style="border-left-color: var(--success-color) !important;">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <div class="stat-label">通过 (AC)</div>
                            <div class="stat-value text-success" id="stat-ac">--</div>
                        </div>
                        <i class="bi bi-check-circle text-success" style="font-size: 2rem; opacity: 0.3;"></i>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-xl-3 col-md-6">
            <div class="card stat-card border-0 h-100" style="border-left-color: var(--warning-color) !important;">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <div class="stat-label">本周提交</div>
                            <div class="stat-value text-warning" id="stat-week">--</div>
                        </div>
                        <i class="bi bi-calendar-week text-warning" style="font-size: 2rem; opacity: 0.3;"></i>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-xl-3 col-md-6">
            <div class="card stat-card border-0 h-100" style="border-left-color: #6f42c1 !important;">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <div class="stat-label">连续天数</div>
                            <div class="stat-value" style="color: #6f42c1;" id="stat-streak">--</div>
                        </div>
                        <i class="bi bi-fire" style="font-size: 2rem; opacity: 0.3; color: #6f42c1;"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Row 1: Radar + Heatmap -->
    <div class="row g-3 mb-4">
        <div class="col-lg-5">
            <div class="chart-container">
                <div class="chart-title"><i class="bi bi-radar"></i> 能力雷达图</div>
                <div id="radar-chart" style="height: 350px;"></div>
            </div>
        </div>
        <div class="col-lg-7">
            <div class="chart-container">
                <div class="chart-title"><i class="bi bi-calendar3"></i> 做题日历</div>
                <div id="heatmap-chart" style="height: 350px;"></div>
            </div>
        </div>
    </div>

    <!-- Row 2: Difficulty Distribution + Recent Submissions -->
    <div class="row g-3 mb-4">
        <div class="col-lg-5">
            <div class="chart-container">
                <div class="chart-title"><i class="bi bi-bar-chart"></i> 难度分布</div>
                <div id="difficulty-chart" style="height: 350px;"></div>
            </div>
        </div>
        <div class="col-lg-7">
            <div class="chart-container">
                <div class="chart-title"><i class="bi bi-clock-history"></i> 最近提交</div>
                <div class="table-responsive">
                    <table class="table table-sm table-hover mb-0" id="recent-submissions-table">
                        <thead>
                            <tr>
                                <th>时间</th>
                                <th>平台</th>
                                <th>题目</th>
                                <th>状态</th>
                            </tr>
                        </thead>
                        <tbody id="recent-submissions-body">
                            <tr>
                                <td colspan="4" class="text-center text-muted py-3">
                                    <div class="spinner-border spinner-border-sm" role="status"></div> 加载中...
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Row 3: Weakness Alerts -->
    <div class="chart-container" id="weakness-section" style="display: none;">
        <div class="chart-title"><i class="bi bi-exclamation-triangle text-danger"></i> 薄弱环节提醒</div>
        <div class="row g-3" id="weakness-cards"></div>
    </div>

    <!-- Empty Data State (hidden by default, shown by JS if no data) -->
    <div id="empty-data-state" style="display: none;" class="text-center py-5">
        <i class="bi bi-inbox text-muted" style="font-size: 4rem;"></i>
        <h4 class="mt-3 text-muted">暂无做题数据</h4>
        <p class="text-muted">请先在设置中绑定 OJ 平台账号并同步数据。</p>
        <a href="{{ url_for('settings.index') }}" class="btn btn-outline-primary">
            <i class="bi bi-gear"></i> 前往设置
        </a>
    </div>

    {% endif %}
</div>
{% endblock %}

{% block extra_scripts %}
{% if current_student %}
<script src="{{ url_for('static', filename='js/dashboard.js') }}"></script>
{% endif %}
{% endblock %}
