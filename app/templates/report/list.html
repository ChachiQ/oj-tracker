{% extends "base.html" %}
{% from "_macros.html" import page_header, empty_state, table_col_class, student_selector %}

{% block title %}学习报告 - OJ Tracker{% endblock %}

{% block content %}
{% call page_header("学习报告", "bi-file-earmark-text") %}
    {% if students and students|length > 0 %}
    {{ student_selector(students, selected_student_id, url_for('report.list_reports'), label='筛选学生：', show_all=true) }}
    <button type="button" class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#generateModal">
        <i class="bi bi-plus-circle"></i> 生成报告
    </button>
    {% endif %}
{% endcall %}

<!-- Report Type Filter -->
{% if students and students|length > 0 %}
<div class="mb-3">
    <div class="btn-group btn-group-sm" role="group">
        <a href="{{ url_for('report.list_reports', student_id=selected_student_id) }}"
           class="btn {{ 'btn-primary' if not current_report_type else 'btn-outline-primary' }}">全部</a>
        <a href="{{ url_for('report.list_reports', student_id=selected_student_id, report_type='weekly') }}"
           class="btn {{ 'btn-primary' if current_report_type == 'weekly' else 'btn-outline-primary' }}">周报</a>
        <a href="{{ url_for('report.list_reports', student_id=selected_student_id, report_type='monthly') }}"
           class="btn {{ 'btn-primary' if current_report_type == 'monthly' else 'btn-outline-primary' }}">月报</a>
        <a href="{{ url_for('report.list_reports', student_id=selected_student_id, report_type='quarterly') }}"
           class="btn {{ 'btn-primary' if current_report_type == 'quarterly' else 'btn-outline-primary' }}">季报</a>
    </div>
</div>
{% endif %}

{% if reports and reports|length > 0 %}
<div class="card shadow-sm">
    <div class="table-responsive">
        <table class="table table-hover mb-0">
            <thead class="table-light">
                <tr>
                    <th class="{{ table_col_class('sm') }}">#</th>
                    <th>学生</th>
                    <th>类型</th>
                    <th>周期</th>
                    <th class="{{ table_col_class('md') }}">生成时间</th>
                    <th class="text-center">操作</th>
                </tr>
            </thead>
            <tbody>
                {% for report in reports %}
                <tr>
                    <td class="{{ table_col_class('sm') }}">{{ loop.index }}</td>
                    <td>
                        {% if report.student %}
                            {{ report.student.name }}
                        {% else %}-{% endif %}
                    </td>
                    <td>
                        <span class="badge {% if report.report_type == 'weekly' %}bg-info{% elif report.report_type == 'monthly' %}bg-primary{% else %}bg-success{% endif %}">
                            {% if report.report_type == 'weekly' %}周报{% elif report.report_type == 'monthly' %}月报{% else %}季报{% endif %}
                        </span>
                    </td>
                    <td>
                        {% if report.period_start and report.period_end %}
                            {{ report.period_start.strftime('%m/%d') }} - {{ report.period_end.strftime('%m/%d') }}
                        {% else %}
                            {{ report.period or '-' }}
                        {% endif %}
                    </td>
                    <td class="{{ table_col_class('md') }}">{{ report.created_at.strftime('%Y-%m-%d %H:%M') if report.created_at else '-' }}</td>
                    <td class="text-center">
                        <div class="btn-group btn-group-sm">
                            <a href="{{ url_for('report.detail', report_id=report.id) }}" class="btn btn-outline-primary">
                                <i class="bi bi-eye"></i> 查看
                            </a>
                            <form method="POST" action="{{ url_for('report.delete', report_id=report.id) }}" class="d-inline"
                                  data-confirm="确定要删除此报告吗？" data-confirm-ok-class="btn-danger" data-confirm-ok-text="删除">
                                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                <button type="submit" class="btn btn-outline-danger">
                                    <i class="bi bi-trash"></i>
                                </button>
                            </form>
                        </div>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>
{% else %}
{% call empty_state('bi-file-earmark-text', '暂无报告') %}
    <p class="text-muted">
        {% if students and students|length > 0 %}
            点击"生成报告"按钮为学生创建第一份学习报告。
        {% else %}
            请先添加学生并绑定 OJ 平台账号。
        {% endif %}
    </p>
{% endcall %}
{% endif %}

<!-- Generate Report Modal -->
{% if students and students|length > 0 %}
<div class="modal fade" id="generateModal" tabindex="-1" aria-labelledby="generateModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <form id="generateForm" method="POST" action="{{ url_for('report.generate') }}">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <div class="modal-header">
                    <h5 class="modal-title" id="generateModalLabel">
                        <i class="bi bi-file-earmark-plus"></i> 生成学习报告
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="关闭"></button>
                </div>
                <div class="modal-body">
                    <!-- Form fields -->
                    <div id="generateFormFields">
                        <div class="mb-3">
                            <label for="gen-student" class="form-label">选择学生 <span class="text-danger">*</span></label>
                            <select class="form-select" id="gen-student" name="student_id" required>
                                <option value="">-- 请选择 --</option>
                                {% for s in students %}
                                <option value="{{ s.id }}" {% if selected_student_id and s.id == selected_student_id %}selected{% endif %}>
                                    {{ s.name }}
                                </option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="gen-type" class="form-label">报告类型 <span class="text-danger">*</span></label>
                            <select class="form-select" id="gen-type" name="report_type" required>
                                <option value="weekly" {{ 'selected' if current_report_type == 'weekly' or not current_report_type }}>周报</option>
                                <option value="monthly" {{ 'selected' if current_report_type == 'monthly' }}>月报</option>
                                <option value="quarterly" {{ 'selected' if current_report_type == 'quarterly' }}>季报</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="gen-period" class="form-label">报告周期 <span class="text-danger">*</span></label>
                            <select class="form-select" id="gen-period" name="period" required>
                            </select>
                        </div>
                        <div class="alert alert-info">
                            <i class="bi bi-info-circle"></i>
                            报告将由 AI 自动分析学生最近的做题数据并生成，生成过程可能需要几分钟时间。
                        </div>
                    </div>
                    <!-- Loading area (hidden by default) -->
                    <div id="generateLoading" class="text-center py-4 d-none">
                        <div class="spinner-border text-primary mb-3" role="status"></div>
                        <p class="text-muted mb-1">AI 正在生成报告...</p>
                        <p class="text-muted timer-text mb-0"></p>
                    </div>
                    <!-- Error area (hidden by default) -->
                    <div id="generateError" class="d-none">
                        <div class="alert alert-danger mb-0"></div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" id="generateCancelBtn" data-bs-dismiss="modal">取消</button>
                    <button type="submit" class="btn btn-primary" id="generateSubmitBtn">
                        <i class="bi bi-lightning"></i> 开始生成
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endif %}
{% endblock %}

{% block extra_scripts %}
<script>
(function() {
    var typeSelect = document.getElementById('gen-type');
    var periodSelect = document.getElementById('gen-period');
    var studentSelect = document.getElementById('gen-student');
    if (!typeSelect || !periodSelect) return;

    var existingReports = {{ existing_reports_map|tojson }};

    function pad(n) { return n < 10 ? '0' + n : '' + n; }

    function getExistingPeriods(type) {
        var sid = studentSelect ? studentSelect.value : '';
        if (!sid || !existingReports[sid] || !existingReports[sid][type]) return [];
        return existingReports[sid][type];
    }

    function buildWeeklyOptions() {
        var options = [];
        var today = new Date();
        // Find the coming Sunday (end of current week, Mon-Sun)
        var dayOfWeek = today.getDay(); // 0=Sun
        var endOfWeek = new Date(today);
        endOfWeek.setDate(today.getDate() + (dayOfWeek === 0 ? 0 : 7 - dayOfWeek));
        // Start from i=1 to skip current (incomplete) week
        for (var i = 1; i <= 8; i++) {
            var sun = new Date(endOfWeek);
            sun.setDate(endOfWeek.getDate() - i * 7);
            var mon = new Date(sun);
            mon.setDate(sun.getDate() - 6);
            var label = (mon.getMonth()+1) + '/' + mon.getDate() + ' - ' + (sun.getMonth()+1) + '/' + sun.getDate();
            var value = sun.getFullYear() + '-' + pad(sun.getMonth()+1) + '-' + pad(sun.getDate());
            options.push({label: label, value: value});
        }
        return options;
    }

    function buildMonthlyOptions() {
        var options = [];
        var today = new Date();
        // Start from i=1 to skip current (incomplete) month
        for (var i = 1; i <= 6; i++) {
            var d = new Date(today.getFullYear(), today.getMonth() - i, 1);
            var label = d.getFullYear() + '年' + (d.getMonth()+1) + '月';
            var value = d.getFullYear() + '-' + pad(d.getMonth()+1);
            options.push({label: label, value: value});
        }
        return options;
    }

    function buildQuarterlyOptions() {
        var options = [];
        var today = new Date();
        var curQ = Math.floor(today.getMonth() / 3) + 1;
        var curY = today.getFullYear();
        // Start from i=1 to skip current (incomplete) quarter
        for (var i = 1; i <= 4; i++) {
            var q = curQ - i;
            var y = curY;
            while (q <= 0) { q += 4; y--; }
            var startM = (q - 1) * 3 + 1;
            var endM = q * 3;
            var label = y + '年第' + q + '季度 (' + startM + '-' + endM + '月)';
            var value = y + '-' + q;
            options.push({label: label, value: value});
        }
        return options;
    }

    function updatePeriodOptions() {
        var type = typeSelect.value;
        var options;
        if (type === 'weekly') options = buildWeeklyOptions();
        else if (type === 'monthly') options = buildMonthlyOptions();
        else options = buildQuarterlyOptions();

        var existing = getExistingPeriods(type);

        periodSelect.innerHTML = '';
        for (var i = 0; i < options.length; i++) {
            var opt = document.createElement('option');
            opt.value = options[i].value;
            var label = options[i].label;
            if (existing.indexOf(options[i].value) !== -1) {
                label += ' (已生成)';
            }
            opt.textContent = label;
            if (i === 0) opt.selected = true;
            periodSelect.appendChild(opt);
        }
    }

    typeSelect.addEventListener('change', updatePeriodOptions);
    if (studentSelect) studentSelect.addEventListener('change', updatePeriodOptions);
    updatePeriodOptions();

    /* --- AJAX generate with loading --- */
    var form = document.getElementById('generateForm');
    var formFields = document.getElementById('generateFormFields');
    var loadingEl = document.getElementById('generateLoading');
    var errorEl = document.getElementById('generateError');
    var cancelBtn = document.getElementById('generateCancelBtn');
    var submitBtn = document.getElementById('generateSubmitBtn');
    var modal = document.getElementById('generateModal');
    var bsModal = null;

    if (!form) return;

    var timerId = null;
    function startTimer() {
        var seconds = 0;
        var timerSpan = loadingEl.querySelector('.timer-text');
        timerSpan.textContent = '';
        timerId = setInterval(function() {
            seconds++;
            var text = '(' + seconds + 's)';
            if (seconds >= 60) text = '(' + seconds + 's · 超时风险，请耐心等待)';
            else if (seconds >= 30) text = '(' + seconds + 's · 通常 10~30s 完成)';
            timerSpan.textContent = text;
        }, 1000);
    }
    function stopTimer() {
        if (timerId) { clearInterval(timerId); timerId = null; }
    }

    function showLoading() {
        formFields.classList.add('d-none');
        errorEl.classList.add('d-none');
        loadingEl.classList.remove('d-none');
        submitBtn.disabled = true;
        cancelBtn.disabled = true;
        // Prevent closing the modal
        if (!bsModal) bsModal = bootstrap.Modal.getInstance(modal);
        if (bsModal) bsModal._config.backdrop = 'static';
        modal.querySelector('.btn-close').classList.add('d-none');
        startTimer();
    }

    function showError(msg) {
        stopTimer();
        loadingEl.classList.add('d-none');
        formFields.classList.remove('d-none');
        errorEl.classList.remove('d-none');
        errorEl.querySelector('.alert').textContent = msg;
        submitBtn.disabled = false;
        cancelBtn.disabled = false;
        modal.querySelector('.btn-close').classList.remove('d-none');
    }

    form.addEventListener('submit', function(e) {
        e.preventDefault();
        showLoading();

        var formData = new FormData(form);
        fetch(form.action, {
            method: 'POST',
            headers: { 'X-Requested-With': 'XMLHttpRequest' },
            body: formData
        })
        .then(function(r) { return r.json(); })
        .then(function(data) {
            stopTimer();
            if (data.success) {
                window.location.href = '{{ url_for("report.detail", report_id=0) }}'.replace('/0', '/' + data.report_id);
            } else {
                showError(data.error || '生成失败');
            }
        })
        .catch(function(err) {
            showError('请求失败: ' + err.message);
        });
    });
})();
</script>
{% endblock %}
