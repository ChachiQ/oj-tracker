{% extends "base.html" %}
{% from "_macros.html" import page_header, empty_state, table_col_class, student_selector %}

{% block title %}学习报告 - OJ Tracker{% endblock %}

{% block content %}
{% call page_header("学习报告", "bi-file-earmark-text") %}
    {% if students and students|length > 0 %}
    {{ student_selector(students, selected_student_id, url_for('report.list_reports'), label='筛选学生：', show_all=true) }}
    <button type="button" class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#generateModal">
        <i class="bi bi-plus-circle"></i> 生成报告
    </button>
    {% endif %}
{% endcall %}

<!-- Report Type Filter -->
{% if students and students|length > 0 %}
<div class="mb-3">
    <div class="btn-group btn-group-sm" role="group">
        <a href="{{ url_for('report.list_reports', student_id=selected_student_id) }}"
           class="btn {{ 'btn-primary' if not current_report_type else 'btn-outline-primary' }}">全部</a>
        <a href="{{ url_for('report.list_reports', student_id=selected_student_id, report_type='weekly') }}"
           class="btn {{ 'btn-primary' if current_report_type == 'weekly' else 'btn-outline-primary' }}">周报</a>
        <a href="{{ url_for('report.list_reports', student_id=selected_student_id, report_type='monthly') }}"
           class="btn {{ 'btn-primary' if current_report_type == 'monthly' else 'btn-outline-primary' }}">月报</a>
        <a href="{{ url_for('report.list_reports', student_id=selected_student_id, report_type='quarterly') }}"
           class="btn {{ 'btn-primary' if current_report_type == 'quarterly' else 'btn-outline-primary' }}">季报</a>
    </div>
</div>
{% endif %}

{% if reports and reports|length > 0 %}
<div class="card shadow-sm">
    <div class="table-responsive">
        <table class="table table-hover mb-0">
            <thead class="table-light">
                <tr>
                    <th class="{{ table_col_class('sm') }}">#</th>
                    <th>学生</th>
                    <th>类型</th>
                    <th>周期</th>
                    <th class="{{ table_col_class('md') }}">生成时间</th>
                    <th class="text-center">操作</th>
                </tr>
            </thead>
            <tbody>
                {% for report in reports %}
                <tr>
                    <td class="{{ table_col_class('sm') }}">{{ loop.index }}</td>
                    <td>
                        {% if report.student %}
                            {{ report.student.name }}
                        {% else %}-{% endif %}
                    </td>
                    <td>
                        <span class="badge {% if report.report_type == 'weekly' %}bg-info{% elif report.report_type == 'monthly' %}bg-primary{% else %}bg-success{% endif %}">
                            {% if report.report_type == 'weekly' %}周报{% elif report.report_type == 'monthly' %}月报{% else %}季报{% endif %}
                        </span>
                    </td>
                    <td>
                        {% if report.period_start and report.period_end %}
                            {{ report.period_start.strftime('%m/%d') }} - {{ report.period_end.strftime('%m/%d') }}
                        {% else %}
                            {{ report.period or '-' }}
                        {% endif %}
                    </td>
                    <td class="{{ table_col_class('md') }}">{{ report.created_at.strftime('%Y-%m-%d %H:%M') if report.created_at else '-' }}</td>
                    <td class="text-center">
                        <div class="btn-group btn-group-sm">
                            <a href="{{ url_for('report.detail', report_id=report.id) }}" class="btn btn-outline-primary">
                                <i class="bi bi-eye"></i> 查看
                            </a>
                            <form method="POST" action="{{ url_for('report.delete', report_id=report.id) }}" class="d-inline">
                                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                <button type="submit" class="btn btn-outline-danger" onclick="return confirm('确定要删除此报告吗？')">
                                    <i class="bi bi-trash"></i>
                                </button>
                            </form>
                        </div>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>
{% else %}
{% call empty_state('bi-file-earmark-text', '暂无报告') %}
    <p class="text-muted">
        {% if students and students|length > 0 %}
            点击"生成报告"按钮为学生创建第一份学习报告。
        {% else %}
            请先添加学生并绑定 OJ 平台账号。
        {% endif %}
    </p>
{% endcall %}
{% endif %}

<!-- Generate Report Modal -->
{% if students and students|length > 0 %}
<div class="modal fade" id="generateModal" tabindex="-1" aria-labelledby="generateModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <form method="POST" action="{{ url_for('report.generate') }}">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <div class="modal-header">
                    <h5 class="modal-title" id="generateModalLabel">
                        <i class="bi bi-file-earmark-plus"></i> 生成学习报告
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="关闭"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="gen-student" class="form-label">选择学生 <span class="text-danger">*</span></label>
                        <select class="form-select" id="gen-student" name="student_id" required>
                            <option value="">-- 请选择 --</option>
                            {% for s in students %}
                            <option value="{{ s.id }}" {% if selected_student_id and s.id == selected_student_id %}selected{% endif %}>
                                {{ s.name }}
                            </option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="gen-type" class="form-label">报告类型 <span class="text-danger">*</span></label>
                        <select class="form-select" id="gen-type" name="report_type" required>
                            <option value="weekly">周报</option>
                            <option value="monthly">月报</option>
                            <option value="quarterly">季报</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="gen-date" class="form-label">截止日期</label>
                        <input type="date" class="form-control" id="gen-date" name="end_date">
                        <div class="form-text">留空则使用当前日期</div>
                    </div>
                    <div class="alert alert-info">
                        <i class="bi bi-info-circle"></i>
                        报告将由 AI 自动分析学生最近的做题数据并生成，生成过程可能需要几分钟时间。
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="submit" class="btn btn-primary">
                        <i class="bi bi-lightning"></i> 开始生成
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endif %}
{% endblock %}
