{% extends "base.html" %}
{% from "_macros.html" import stat_card, chart_box %}

{% block title %}学习报告详情 - OJ Tracker{% endblock %}

{% block content %}
<div class="d-flex align-items-center mb-4">
    <a href="{{ url_for('report.list_reports') }}" class="btn btn-outline-secondary btn-sm me-3">
        <i class="bi bi-arrow-left"></i>
    </a>
    <h4 class="fw-bold mb-0"><i class="bi bi-file-earmark-text"></i> 学习报告</h4>
</div>

<!-- Report Header -->
<div class="card shadow-sm mb-4">
    <div class="card-body">
        <div class="row align-items-center">
            <div class="col-12 col-md-8">
                <h5 class="fw-bold mb-2">
                    {{ report.student.name if report.student else '未知学生' }}
                    -
                    <span class="badge {% if report.report_type == 'weekly' %}bg-info{% elif report.report_type == 'monthly' %}bg-primary{% else %}bg-success{% endif %}">
                        {% if report.report_type == 'weekly' %}周报{% elif report.report_type == 'monthly' %}月报{% else %}季报{% endif %}
                    </span>
                </h5>
                <p class="text-muted mb-0">
                    <i class="bi bi-calendar3"></i>
                    报告周期：
                    {% if report.period_start and report.period_end %}
                        {{ report.period_start.strftime('%Y-%m-%d') }} 至 {{ report.period_end.strftime('%Y-%m-%d') }}
                    {% else %}
                        {{ report.period or '-' }}
                    {% endif %}
                    <span class="mx-2">|</span>
                    <i class="bi bi-clock"></i>
                    生成时间：{{ report.created_at.strftime('%Y-%m-%d %H:%M') if report.created_at else '-' }}
                </p>
            </div>
            <div class="col-12 col-md-4 text-md-end mt-3 mt-md-0">
                <a href="{{ url_for('report.list_reports') }}" class="btn btn-outline-secondary btn-sm">
                    <i class="bi bi-list"></i> 返回列表
                </a>
                <form method="POST" action="{{ url_for('report.regenerate', report_id=report.id) }}" class="d-inline">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                    <button type="submit" class="btn btn-outline-warning btn-sm" onclick="return confirm('确定要重新生成此报告吗？旧报告将被替换。')">
                        <i class="bi bi-arrow-clockwise"></i> 重新生成
                    </button>
                </form>
                <form method="POST" action="{{ url_for('report.delete', report_id=report.id) }}" class="d-inline">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                    <button type="submit" class="btn btn-outline-danger btn-sm" onclick="return confirm('确定要删除此报告吗？此操作不可撤销。')">
                        <i class="bi bi-trash"></i> 删除
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>

<div class="row g-4">
    <!-- Stats Summary -->
    {% if report.stats %}
    <div class="col-12">
        <div class="row g-3">
            {{ stat_card('总提交', report.stats.get('submissions', 0), 'primary') }}
            {{ stat_card('通过数', report.stats.get('ac_count', 0), 'success') }}
            {{ stat_card('通过率', report.stats.get('pass_rate', '0') ~ '%', 'warning') }}
            {{ stat_card('活跃天数', report.stats.get('active_days', 0), 'info') }}
        </div>
    </div>
    {% endif %}

    <!-- Radar Comparison Chart -->
    <div class="col-12 col-lg-5">
        <div class="chart-container">
            <div class="chart-title"><i class="bi bi-radar"></i> 能力变化对比</div>
            <div id="report-radar" class="chart-responsive"
                 data-prev="{{ report.prev_scores|tojson if report.prev_scores else '{}' }}"
                 data-curr="{{ report.curr_scores|tojson if report.curr_scores else '{}' }}"
                 style="height: 380px;">
            </div>
        </div>
    </div>

    <!-- AI Report Content -->
    <div class="col-12 col-lg-7">
        <div class="chart-container">
            <div class="chart-title"><i class="bi bi-robot"></i> AI 分析报告</div>
            <div class="report-content">
                {% if report.content %}
                    {{ report.content|md2html|safe }}
                {% else %}
                    <p class="text-muted text-center py-3">暂无报告内容</p>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Detailed Sections -->
{% if report.sections %}
<div class="row g-4 mt-2">
    {% for section in report.sections %}
    <div class="col-12">
        <div class="chart-container">
            <div class="chart-title">{{ section.title }}</div>
            <div class="report-content">{{ section.content|safe }}</div>
        </div>
    </div>
    {% endfor %}
</div>
{% endif %}

<!-- Back Button -->
<div class="text-center mt-4 mb-4">
    <a href="{{ url_for('report.list_reports') }}" class="btn btn-outline-secondary">
        <i class="bi bi-arrow-left"></i> 返回报告列表
    </a>
</div>
{% endblock %}

{% block extra_scripts %}
<script src="{{ url_for('static', filename='js/report.js') }}"></script>
{% endblock %}
