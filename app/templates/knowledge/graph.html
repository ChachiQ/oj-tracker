{% extends "base.html" %}
{% from "_macros.html" import page_header, chart_box, empty_state, student_selector %}

{% block title %}知识图谱 - OJ Tracker{% endblock %}

{% block extra_css %}
<style>
    #node-detail-panel {
        position: fixed;
        right: 20px;
        top: 80px;
        width: 320px;
        max-width: calc(100vw - 40px);
        z-index: 1000;
        display: none;
    }
    #node-detail-panel .card {
        box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15);
    }
    /* Progress panel */
    #ai-progress-panel {
        display: none;
    }
    #ai-progress-panel .progress-step {
        padding: 4px 0;
        font-size: 0.9rem;
        color: #6c757d;
    }
    #ai-progress-panel .progress-step.done {
        color: #1cc88a;
    }
    #ai-progress-panel .progress-step.active {
        color: #4e73df;
        font-weight: 500;
    }
    #ai-progress-panel .progress-step.error {
        color: #e74a3b;
    }
    /* Assessment history accordion */
    .assessment-item .accordion-button {
        padding: 0.6rem 1rem;
        font-size: 0.9rem;
    }
    .assessment-item .accordion-button:not(.collapsed) {
        background-color: #f0f4ff;
    }
    .assessment-item .btn-delete-assessment {
        opacity: 0.5;
        transition: opacity 0.2s;
    }
    .assessment-item:hover .btn-delete-assessment {
        opacity: 1;
    }
    /* Stage card clickable */
    .stage-card {
        cursor: pointer;
        transition: border-color 0.2s, box-shadow 0.2s;
    }
    .stage-card:hover {
        box-shadow: 0 0 0 2px rgba(78,115,223,0.25);
    }
    .stage-card.active {
        border-color: #4e73df !important;
        box-shadow: 0 0 0 2px rgba(78,115,223,0.35);
    }
    /* Stacked progress bar */
    .stage-stacked-bar {
        display: flex;
        height: 8px;
        border-radius: 4px;
        overflow: hidden;
        background-color: #e9ecef;
        margin-top: 6px;
    }
    .stage-stacked-bar .bar-segment {
        height: 100%;
        transition: width 0.4s ease;
    }
    /* Stage detail panel */
    #stage-detail-panel {
        display: none;
    }
    #stage-detail-panel .tag-grid {
        display: flex;
        flex-wrap: wrap;
        gap: 6px;
    }
    .tag-badge {
        display: inline-block;
        padding: 3px 10px;
        border-radius: 12px;
        font-size: 0.8rem;
        font-weight: 500;
    }
    .tag-badge.status-mastered {
        background-color: rgba(28,200,138,0.15);
        color: #1cc88a;
        border: 1px solid rgba(28,200,138,0.3);
    }
    .tag-badge.status-learning {
        background-color: rgba(246,194,62,0.15);
        color: #b8860b;
        border: 1px solid rgba(246,194,62,0.3);
    }
    .tag-badge.status-weak {
        background-color: rgba(231,74,59,0.15);
        color: #e74a3b;
        border: 1px solid rgba(231,74,59,0.3);
    }
    .tag-badge.status-untouched {
        background-color: rgba(209,211,226,0.15);
        color: #858796;
        border: 1px solid rgba(209,211,226,0.4);
    }
    /* Fullscreen mode for knowledge graph */
    #knowledge-graph-wrapper.fullscreen {
        position: fixed;
        top: 0;
        left: 0;
        width: 100vw;
        height: 100vh;
        z-index: 9999;
        margin: 0;
        border-radius: 0;
        background: #fff;
        padding: 15px;
        overflow: hidden;
    }
    #knowledge-graph-wrapper.fullscreen #knowledge-graph {
        height: calc(100vh - 70px) !important;
    }
</style>
{% endblock %}

{% block content %}
{% call page_header("知识图谱", "bi-diagram-3") %}
    {{ student_selector(students, current_student.id if current_student else none, url_for('knowledge.graph')) }}
    {% if current_student %}
    <button id="btn-ai-analyze" class="btn btn-primary btn-sm"
            onclick="triggerAIAnalysis({{ current_student.id }})">
        <i class="bi bi-robot"></i> AI 智能分析
    </button>
    {% endif %}
{% endcall %}

{% if current_student %}
<!-- Stage Progress Bar -->
<div class="chart-container mb-4">
    <div class="chart-title"><i class="bi bi-bar-chart-steps"></i> 学习阶段总览</div>
    <div class="row g-3" id="stage-cards">
        {% set stage_names = {1: '语法基础', 2: '基础算法', 3: 'CSP-J', 4: 'CSP-S', 5: '省选', 6: 'NOI'} %}
        {% set stage_colors = {1: '#91cc75', 2: '#5470c6', 3: '#73c0de', 4: '#fac858', 5: '#ee6666', 6: '#9a60b4'} %}
        {% for stage_id, stage_name in stage_names.items() %}
        <div class="col-lg-2 col-md-4 col-6">
            <div class="stage-card" id="stage-card-{{ stage_id }}" onclick="toggleStageDetail({{ stage_id }})">
                <div class="stage-number" style="color: {{ stage_colors[stage_id] }};">{{ stage_name }}</div>
                <div class="stage-stacked-bar" id="stage-{{ stage_id }}-bar">
                    <div class="bar-segment" id="stage-{{ stage_id }}-mastered" style="width: 0%; background-color: #1cc88a;"></div>
                    <div class="bar-segment" id="stage-{{ stage_id }}-learning" style="width: 0%; background-color: #f6c23e;"></div>
                    <div class="bar-segment" id="stage-{{ stage_id }}-weak" style="width: 0%; background-color: #e74a3b;"></div>
                </div>
                <div class="mt-1">
                    <small id="stage-{{ stage_id }}-text" class="text-muted">加载中...</small>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
</div>

<!-- Stage Detail Panel (expandable) -->
<div id="stage-detail-panel" class="chart-container mb-4">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <div class="chart-title mb-0" id="stage-detail-title"><i class="bi bi-tags"></i> 阶段详情</div>
        <button type="button" class="btn-close" onclick="closeStageDetail()"></button>
    </div>
    <div id="stage-detail-content"></div>
</div>

<!-- AI Nudge Banner (shown when no reports or new submissions) -->
<div id="ai-nudge-banner" class="mb-4" style="display: none;"></div>

<!-- AI Analysis Warning Banner (shown during analysis) -->
<div id="ai-analyzing-banner" class="alert alert-warning d-flex align-items-center mb-4" style="display: none !important;">
    <span class="spinner-border spinner-border-sm me-2"></span>
    <span>AI 正在生成分析报告，请耐心等待，离开页面将中断分析。</span>
</div>

<!-- AI Analysis Progress Panel -->
<div id="ai-progress-panel" class="chart-container mb-4">
    <div class="chart-title"><i class="bi bi-robot"></i> AI 分析进度</div>
    <div id="ai-progress-steps"></div>
</div>

<!-- AI Assessment History (accordion) -->
<div id="ai-assessment-card" class="chart-container mb-4" style="display: none;">
    <div class="chart-title"><i class="bi bi-robot"></i> AI 知识评估报告</div>
    <div id="ai-assessment-history" class="accordion accordion-flush"></div>
</div>

<!-- Knowledge Graph Container (with legend + fullscreen) -->
<div class="chart-container" id="knowledge-graph-wrapper">
    <div class="d-flex justify-content-between align-items-center" style="position: relative; z-index: 1;">
        <div class="chart-title"><i class="bi bi-share"></i> 知识点关系图</div>
        <div>
            <button class="btn btn-outline-secondary btn-sm" onclick="rotateGraphBy(-30)" title="逆时针旋转">
                <i class="bi bi-arrow-counterclockwise"></i>
            </button>
            <button class="btn btn-outline-secondary btn-sm" onclick="rotateGraphBy(30)" title="顺时针旋转">
                <i class="bi bi-arrow-clockwise"></i>
            </button>
            <button class="btn btn-outline-secondary btn-sm" id="btn-graph-fullscreen" onclick="toggleGraphFullscreen()" title="全屏查看">
                <i class="bi bi-arrows-fullscreen"></i>
            </button>
        </div>
    </div>
    <div id="knowledge-graph" class="chart-responsive-lg" data-student-id="{{ current_student.id }}"></div>
</div>

<!-- Node Detail Panel (floating) -->
<div id="node-detail-panel"></div>

{% else %}
{% call empty_state('bi-diagram-3', '请选择学生查看知识图谱') %}
    {% if not students or students|length == 0 %}
    <p class="text-muted">请先添加学生。</p>
    <a href="{{ url_for('student.add_student') }}" class="btn btn-primary">
        <i class="bi bi-plus-circle"></i> 添加学生
    </a>
    {% endif %}
{% endcall %}
{% endif %}
{% endblock %}

{% block extra_scripts %}
{% if current_student %}
<script src="{{ url_for('static', filename='js/knowledge_graph.js') }}"></script>
{% endif %}
{% endblock %}
